- hosts: master_nodes:worker_nodes
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true
  connection: lxd
  tasks:
    #  - name: Hack required to provision K8s v1.15+ in LXC containers
    #    shell: |
    #            sudo apt install -qq -y net-tools
    #            sudo mknod /dev/kmsg c 1 11
    #            echo 'mknod /dev/kmsg c 1 11' | sudo tee  /etc/rc.local
    #            sudo chmod +x /etc/rc.local
         
    #  - name: patch to shared mount propagation to run calico node 
    #    shell: sudo mount --make-rshared /

    #  - name: patch to create symlink for /dev/kmsg for kubelet proper functionality
    #    shell: |
    #            echo 'L /dev/kmsg - - - - /dev/console' > /etc/tmpfiles.d/kmsg.conf
               
    #  - name: prepare nodes to connect to nfs server
    #    shell: sudo   apt install -y nfs-common

    - name: Create a new file with permissions
      file:
          path: "/root/patch.sh"
          state: touch
          mode: 0755
          owner: root

    - name: add patch.sh file  content
      copy:
          dest: "/root/patch.sh"
          content: |
              #!/bin/bash
              sudo apt install -qq -y net-tools
              sudo mknod /dev/kmsg c 1 11
              echo 'mknod /dev/kmsg c 1 11' | sudo tee  /etc/rc.local
              sudo chmod +x /etc/rc.local
              sudo mount --make-rshared /
              echo 'L /dev/kmsg - - - - /dev/console' > /etc/tmpfiles.d/kmsg.conf

    - name: Create a new service file  with permissions
      file:
          path: "/etc/systemd/system/patch.service"
          state: touch
          mode: 0777
          owner: root

    - name: add patch.service file  content
      copy:
          dest: "/etc/systemd/system/patch.service"
          content: |
                [Unit]
                Description=Job that runs your user script to patch lxd

                [Service]
                ExecStart=/bin/bash /root/patch.sh
                Type=oneshot
                RemainAfterExit=yes

                [Install]
                WantedBy=multi-user.target



    - name: enable patch.service
      shell: |
               sudo systemctl enable patch.service
               sudo systemctl start patch.service

    # Add pre-shutdown service 

    - name: Create a new file with permissions
      file:
          path: "/root/pre-shutdown.sh"
          state: touch
          mode: 0755
          owner: root

    - name: add pre-shutdown.sh file  content
      copy:
          dest: "/root/pre-shutdown.sh"
          content: |
            #!/bin/bash
            echo $(date) > /root/output.txt

    - name: Create a new service file  with permissions
      file:
          path: "/etc/systemd/system/pre-shutdown.service"
          state: touch
          mode: 0777
          owner: root

    - name: add pre-shutdown.service file  content
      copy:
          dest: "/etc/systemd/system/pre-shutdown.service"
          content: |
            [Unit]
            Description=Pre-Shutdown Processes
            DefaultDependencies=no
            Before=shutdown.target reboot.target halt.target
            # This works because it is installed in the target and will be
            #   executed before the target state is entered
            # Also consider kexec.target

            [Service]
            Type=oneshot
            # User=smeterlink
            # Group= smeterlink
            ExecStart=/root/pre-shutdown.sh  # your path and filename

            [Install]
            WantedBy=halt.target reboot.target shutdown.target



    - name: enable pre-shutdown.service
      shell: |
                sudo systemctl enable pre-shutdown.service
                sudo systemctl daemon-reload